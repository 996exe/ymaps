var path = require('path'),
    through = require('through2'),
    gulp = require('gulp'),
    concat = require('gulp-concat'),
    es = require('event-stream'),
    wrapper = require('gulp-wrapper');

module.exports = helpersPlugin;

var YM_HELPERS_PATH = '../../../../node_modules/ym-helpers/modules/',
    // These helpers miss even in ymaps environment.
    MUST_HAVE_HELPERS = ['util/providePackage/util.providePackage.js'];

function helpersPlugin (cfg) {
    var inputStream = through.obj(),
        helpersStream = processHelpersStream(cfg.standalone),
        outputStream = es.merge(helpersStream, inputStream)
            .pipe(concat(cfg.concatTo));

    return es.duplex(inputStream, outputStream);
}

function processHelpersStream (standalone) {
    var localGlob = path.resolve(__dirname, './src/**/*.js'),
        ymHelpersGlob = path.resolve(__dirname, YM_HELPERS_PATH + (standalone ? '**/*.js' : MUST_HAVE_HELPERS.join(',')));

    return gulp.src([localGlob, ymHelpersGlob])
        .pipe(concat('__helpers'))
        .pipe(wrapper({
            header: '\n(function (modules){\n',
            footer: '\n})(ym.modules);\n'
        }));
}